---
id: 6bbf21ff-b471-46dc-b31f-7be48d8859c3
title: Cleaning up With PowerShell After Removing a Windows Azure Virtual Machine
abstract: Removing a Windows Azure Virtual Machine doesn't remove everything for you.
  This post is all about cleaning up with PowerShell after removing a Windows Azure
  VM
created_at: 2013-04-28 14:10:00 +0000 UTC
tags:
- PowerShell
- Windows Azure
slugs:
- cleaning-up-with-powershell-after-removing-a-windows-azure-virtual-machine
---

<p>When you remove a <a href="http://www.windowsazure.com">Windows Azure</a> virtual machine, you are not actually removing everything. I hear you saying "What!!!"? Let's dive in then <img class="wlEmoticon wlEmoticon-smile" style="border-style: none;" alt="Smile" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/wlEmoticon-smile.png" /></p>
<p>As each VM is kept under a cloud service, that cloud service is one of those things that remain after you remove your VM. Other thing is the disk (or disks, depends on your case) which is attached to your VM. If you didn't attach any data disks, at least your OS disk will remain inside your storage account even if you remove your VM. However, you cannot go and directly delete that VHD file just like a typical blob because there is a lease on that blob as it's still viewed as one of your registered disks.</p>
<p>Let's look at a case of mine on removing a Windows Azure VM. Yesterday, I created two VMs for demonstration purposes on a presentation and after the presentation, I removed those VMs by running "Remove-AzureVM" PowerShell command. So far, so good. When I go to the portal, I don't see those VMs as expected and I don't see any cloud services.</p>
<blockquote>
<p>If you create a VM, the new portal is not showing that you have a cloud service but it implicitly creates one for you under the covers. As soon as you attach another VM to that cloud service, the cloud service shows up on the new portal as well. In either of these cases, the generated cloud service is completely visible to you through the REST management API. So, you can view them through PowerShell Cmdlets.</p>
</blockquote>
<p>Let's run "Get-AzureService" PowerShell command to see my cloud services:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb.png" width="644" height="307" /></a></p>
<p>These are the generated cloud services which belong to my removed VMs. As far as I know, these cloud services won't cost me anything as they contain no deployments but it would be nice to remove them as I don't need them.</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_3.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_3.png" width="644" height="272" /></a></p>
<p>I got rid of the unnecessary cloud services. The next and final step of this cleaning is to remove the OS disks I have. This's actually more important because disk VHD files are stored inside the Windows Azure storage as blobs and each OS disk is approx. 127GB in size. So, I will pay for them as long as I keep them. Through new <a href="http://michaelwasham.com/2013/03/27/windows-azure-powershell-cmdlets-now-supports-storage/">Windows Azure Storage PowerShell Cmdlets</a>, I can view my VHD container to see which VHD files I have:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/imagee553a272-086d-41b6-83b0-8f714cde23b7.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_4.png" width="644" height="237" /></a></p>
<p>As you can see, I have two unnecessary VHD files which remained after my VM removal. At this stage, you might think directly deleting these blobs but as mentioned before, it will fail if we try to do that.</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_4.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_5.png" width="644" height="237" /></a></p>
<p>The error message I got is very descriptive actually: There is currently a lease on the blob and no lease ID was specified in the request. Let's run another PowerShell command to see which disks I have registered:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_6.png" width="644" height="237" /></a></p>
<p>I have those two blobs registered as my disks and this prevents me from directly deleting them which is perfectly reasonable. To prove that this is actually the case, I will view the HTTP headers of one of those disks through <a href="http://www.cloudberrylab.com/free-microsoft-azure-explorer.aspx">CloudBerry Explorer for Azure Blob Storage</a>:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_5.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_7.png" width="644" height="481" /></a></p>
<p>You can see that "x-ms-lease-status" header is set to "locked" which states that there is a lease on the blob. Let's remove the "IstBootcampDemoTugberk-IstBootcampVM1-2013-4-27-132" disk from my registered disks:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/imagedb6fbd0b-91d9-4efd-a6d0-f1a50e0d98d3.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_8.png" width="644" height="237" /></a></p>
<p>Now, let's look at the HTTP headers of the blob again:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_6.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_9.png" width="644" height="481" /></a></p>
<p>The lease is now taken out and it's now possible to delete the blob:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_10.png" width="644" height="228" /></a></p>
<p>However, you can delete the disk from your registered disks list and the storage container in one go by running "Remove-AzureDisk" PowerShell Cmdlet with "DeleteVHD" switch:</p>
<p><a href="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_7.png"><img title="image" style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" border="0" alt="image" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/image_thumb_11.png" width="644" height="228" /></a></p>
<p>The VHD file is completely gone. I hope the post was helpful <img class="wlEmoticon wlEmoticon-smile" style="border-style: none;" alt="Smile" src="https://www.tugberkugurlu.com/Content/images/Uploadedbyauthors/wlw/Cleaning-up-After-Removing-a-VM_10D34/wlEmoticon-smile.png" /></p>