---
title: ASP.NET 5 Identity MongoDB Implementation
abstract: ASP.NET Identity will have a new version with ASP.NET 5 which is going to
  be version 3.0.0 and I gave it shot to implement ASP.NET Identity MongoDB data store.
created_at: 2015-11-05 20:04:00 +0000 UTC
tags:
- .net
- ASP.Net
- ASP.NET 5
- Identity
- MongoDB
slugs:
- asp-net-5-identity-mongodb-implementation
---

<p>As with everything, <a href="https://github.com/aspnet/Identity">ASP.NET Identity</a> will have a new version with ASP.NET 5 which is going to be version 3.0.0. There are some changes on the interfaces but it’s not as drastic as others. By default, it provides <a href="https://github.com/aspnet/Identity/tree/dev/src/Microsoft.AspNet.Identity.EntityFramework">Entity Framework implementation</a> which I assume going to be compatible with any data storage system that can plug into Entity Framework (which is good). However, you need to provide a custom implementation if you want to support a data storage system which doesn’t support Entity Framework. <a href="https://www.mongodb.org/">MongoDB</a> is one of them and I gave it shot to implement ASP.NET Identity MongoDB <a href="https://github.com/aspnet/Identity/blob/dev/src/Microsoft.AspNet.Identity/IUserStore.cs">store</a>. The result was really good:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/2bc3a21a-62db-4476-912c-941b1e69a5c7.png"><img title="mongodb-aspnet-identity" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="mongodb-aspnet-identity" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/136b0131-cc31-4c8c-a472-959f3fd77b8b.png" width="644" height="345"></a></p> <p>Library is available on NuGet as <a title="https://www.nuget.org/packages/Dnx.Identity.MongoDB" href="https://www.nuget.org/packages/Dnx.Identity.MongoDB">Dnx.Identity.MongoDB</a> package and it supports beta8 runtime release. For now, it’s <a href="https://github.com/tugberkugurlu/ModernShopping/tree/master/Auth/src/Dnx.Identity.MongoDB">part of a sample project I am working on</a> but it will probably make it into its own repository soon. I also have a sample <a href="https://github.com/tugberkugurlu/Identity/tree/beta8-mongodb/samples/IdentitySample.Mvc">here</a> which is the fork of the original Identity sample. You can look at <a href="https://github.com/tugberkugurlu/Identity/commit/55dcc3e956a8152f74fb2a2503965f71f0124b7c">this commit</a> to see what I had to do to make it support my custom provider which is not that bad, if you ignore the <a href="https://github.com/tugberkugurlu/Identity/commit/55dcc3e956a8152f74fb2a2503965f71f0124b7c#diff-7">dependency injection dance</a> I had to make. That’s because my implementation of ASP.NET Identity library doesn’t support <a href="https://github.com/aspnet/Identity/blob/dev/src/Microsoft.AspNet.Identity/IRoleStore.cs">IRoleStore</a>. Don’t worry, you will not need this as you already have <a href="https://github.com/aspnet/Identity/blob/dev/src/Microsoft.AspNet.Identity/IUserClaimStore.cs">IUserClaimStore</a> and also, <a href="https://github.com/aspnet/Identity/issues/581">there is an open issue</a> to change the dependency injection hook a bit so that the IRoleStore would be optional.</p> <p>Here are a few more details about this ASP.NET 5 Identity MongoDB implementation:</p> <ul> <li>Currently, there is no documentation.</li> <li><a href="https://github.com/tugberkugurlu/ModernShopping/blob/97f7cfe51712de887899bfd582e624687c0d50d3/Auth/src/Dnx.Identity.MongoDB/MongoUserStore.cs">MongoUserStore</a> is thread safe. You can register this as a singleton.</li> <li>At the moment, there is no logging and nice exception handling for the implementation.</li> <li>The implementation only supports dnx452 or above and it doesn’t support corefx as <a href="https://github.com/mongodb/mongo-csharp-driver/pull/210">MongoDB .NET Client has no support for that</a>.</li> <li>The library doesn’t support <a href="https://github.com/aspnet/Identity/blob/89d116ae982561a311e3258256dd13e6d51d8242/src/Microsoft.AspNet.Identity/IUserStore.cs#L39">SetUserNameAsync</a> as the user name is also the Id of the user. So, you cannot change the Id.</li> <li>The implementation requires you to pass an implementation of <a href="https://github.com/tugberkugurlu/ModernShopping/blob/97f7cfe51712de887899bfd582e624687c0d50d3/Auth/src/Dnx.Identity.MongoDB/MongoUserStore.cs#L38">IMongoDatabase</a> through the constructor and it persists data into a collection which is named "users". There is going to be a way to change the name of the collection soon in upcoming releases.</li> <li>E-mail uniqueness is ensured through a unique MongoDB index. However, this will not function properly if you shard the users collection.</li> <li>The implementation doesn’t persist changes unless you call one of the <a href="https://github.com/aspnet/Identity/blob/89d116ae982561a311e3258256dd13e6d51d8242/src/Microsoft.AspNet.Identity/IUserStore.cs#L72">UpdateAsync</a>, <a href="https://github.com/aspnet/Identity/blob/89d116ae982561a311e3258256dd13e6d51d8242/src/Microsoft.AspNet.Identity/IUserStore.cs#L64">CreateAsync</a> or <a href="https://github.com/aspnet/Identity/blob/89d116ae982561a311e3258256dd13e6d51d8242/src/Microsoft.AspNet.Identity/IUserStore.cs#L80">DeleteAsync</a> methods (which is what <a href="https://github.com/aspnet/Identity/blob/89d116ae982561a311e3258256dd13e6d51d8242/src/Microsoft.AspNet.Identity/UserManager.cs">UserManager</a> does).</li></ul> <p>Give it a try and you can file issues <a href="https://github.com/tugberkugurlu/ModernShopping/issues">here</a> for now and send pull requests. Enjoy :)</p>  