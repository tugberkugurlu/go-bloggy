---
id: 47fdfbba-823e-4407-9e8e-a221d34777ff
title: How to Use Octopus Deploy Step Templates for SQL Release
abstract: In this post, I will go through how you can use SQL Release Octopus Deploy
  step templates to make the Octopus Deploy Integration of SQL Release easier by going
  through one of the deployment flows.
created_at: 2015-04-06 21:39:00 +0000 UTC
tags:
- Continious Delivery
- DLM
- Octopus Deploy
- SQL Release
- SQL Server
slugs:
- how-to-use-octopus-deploy-step-templates-for-sql-release
---

<p><a href="http://www.red-gate.com/products/dlm/dlm-automation-suite/sql-release">SQL Release</a>, a set of PowerShell cmdlets from <a href="http://www.red-gate.com/">Redgate</a> which automate deploying changes to your production databases, went out of beta and became part of <a href="http://www.red-gate.com/products/dlm/dlm-automation-suite/">DLM Automation Suite</a> a few days ago. As part of this release, <a href="http://library.octopusdeploy.com/#!/listing/redgate">Octopus Deploy step templates for SQL Release</a> are also included inside the suite and in this post, I will go through how you can use these step templates to make the <a href="https://octopusdeploy.com">Octopus Deploy</a> Integration of SQL Release easier by going through one of the deployment flows (the recommended one).</p> <blockquote> <p>If you are trying to integrate your SQL Server databases into your deployment pipeline, I strongly encourage you to try DLM Automation Suite out. At the time of this writing, it has 28-day free trial option. You can also check out <a href="http://documentation.red-gate.com/display/DAS/DLM+Automation+Suite">the documentation page for DLM Automation Suite</a> documentation and information about included products.</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/cab4c6fc-ddca-4dce-859b-db93a8aaa1d6.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/5ad13e2e-4583-4db5-9845-4576d3f92b85.png" width="644" height="368"></a></p></blockquote> <h3>Installing SQL Release Step Templates</h3> <p align="left">If you are not familiar with Step Templates, it’s a plugin mechanism that Octopus Deploy has which allows you to get the input from the user through a nice UI and run specific PowerShell script based on the input passed in. A step template is nothing but a structured JSON text and they are hosted inside the <a href="http://library.octopusdeploy.com">Octopus Deploy Step Templates library</a>. They actually don’t need to be hosted there in order for you to use them but it makes it very convenient to find one in a central place.</p> <p><a href="http://library.octopusdeploy.com/#!/listing/redgate">SQL Release has four step templates</a> to satisfy different flows and use cases.</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/a8d03766-b2ac-4e80-b047-4e9b46123246.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/a649437b-b4c7-40c9-b679-e4fb6c50050b.png" width="644" height="362"></a></p> <p>First thing to do in my demo blog post here is to install these step templates into your Octopus server. The way to install a step template is a little different that you might expect. </p> <ol> <li>Go inside a step template page on Octopus Deploy Library web site.  <li>Hit "Copy to clipboard" button on the right hand side.  <li>Go to your Octopus server and navigate to Library (on the top menu)  <li>You should see the "Step templates" pane on the left side. This will open up the step templates page for your Octopus server.  <li>On that page, hit "Import", paste the step template inside the text area and click "Import".</li></ol> <p>You will end up with a look similar to the following one:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/912e965a-8c0c-47a1-995d-e6ffc7050ff4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/d65a6eba-81e9-4244-83ba-6cc80353271a.png" width="644" height="393"></a></p> <p>After I imported all the step templates for SQL Release, it is time to actually create the deployment process. We will be using only two of these in our example here.</p> <blockquote> <p>In order to use the SQL Release step templates, you need to have <a href="http://documentation.red-gate.com/display/SR1/Installing">SQL Release installed</a> inside the Octopus Tentacle machine. If you install SQL Release while the Tentacle is running, you need to restart the Tentacle service (through the Tentacle Manager, for example).</p></blockquote> <h3>Setting up the Octopus Project</h3> <p>Before going through each step of the deployment process, I wanted first show the end look of the Octopus project.</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/7a321659-f018-42d7-b2a6-bc9064a821fa.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/4c399a94-0d4e-4aa0-ad78-89bfa1634f60.png" width="644" height="349"></a></p> <p>At the end, we will have four steps to complete our deployment for this example. A few more things to point out:</p> <ul> <li>We will be only deploying the database for the purpose of this demo but you can imagine having your application deployment here as well.  <li>We will deploy the database schema changes in two steps in order to allow review and approval of the script.</li></ul> <h4>Download and Extract NuGet Package Step</h4> <p>First step will be to download and extract the NuGet package which contains the scripts folder for the database schema state. This NuGet package will be produced by another DLM Automation Suite tool named <a href="https://www.red-gate.com/products/dlm/dlm-automation-suite/sql-ci">SQL CI</a>, a plugin for your CI tool that allows continuous integration for SQL Server databases. The script folder I mentioned here can be produced by a few Redgate tools such as <a href="http://www.red-gate.com/products/sql-development/sql-source-control/">SQL Source Control</a>. The script folder I am using for this sample is hosted <a href="https://github.com/tugberkugurlu/Geveze/tree/9f196f33e2460c0709beccbf4366eb2b4299174f/db">on my GitHub repository</a>. </p> <p>In order to create a package, I fired the following SQL CI command:</p> <div class="code-wrapper border-shadow-1"> <div style="color: black; background-color: white"><pre>sqlci Build <span style="color: gray">--</span>scriptsFolder<span style="color: gray">=</span><span style="color: #a31515">"D:\github\Geveze\db"</span> <span style="color: gray">--</span>outputFolder<span style="color: gray">=</span><span style="color: #a31515">"D:\github\Geveze"</span> <span style="color: gray">--</span>packageId<span style="color: gray">=</span><span style="color: #a31515">"Geveze"</span> <span style="color: gray">--</span>packageVersion<span style="color: gray">=</span><span style="color: #a31515">"1.0.0"</span></pre></div></div>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/3fcbd1c7-cd94-4945-9d4d-8a6fceab8688.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/80909c60-ccb9-4e8c-86c1-6d837d9b5624.png" width="644" height="328"></a></p>
<p>When I have the package created, I pushed it to Octopus Deploy NuGet feed using <a href="https://docs.nuget.org/consume/command-line-reference">NuGet Command Line</a> tool:</p>
<div class="code-wrapper border-shadow-1">
<div style="color: black; background-color: white"><pre>nuget push Geveze.1.0.0.nupkg <span style="color: gray">-</span>ApiKey API<span style="color: gray">-</span>CMGMYZ1GM95FHJNLWVRQQGQRAPK <span style="color: gray">-</span>Source http:<span style="color: gray">/</span><span style="color: gray">/</span>localhost:4000<span style="color: gray">/</span>nuget<span style="color: gray">/</span>packages</pre></div></div>
<blockquote>
<p>Typically, these steps would be performed inside your CI Server but I didn’t want to have CI integration in order not to complicate things more for this demo. Also, check out the <a href="http://documentation.red-gate.com/display/SCI1/Using+the+command+line">SQL CI Documentation</a> for more information about the command line options and other related stuff. We won’t go into details about this tool in this post.</p></blockquote>
<p>Once I pushed the package to Octopus Deploy NuGet feed, I was able to see the package while I was configuring the step:</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/cfa92553-da2c-4bb6-83ca-b62395033e2e.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/9c764425-ca50-4f62-ad62-fc7aa4af54a6.png" width="644" height="322"></a></p>
<h4>Create Database Release Step</h4>
<p>This is probably the most important step in our process. Here, SQL Release will create the actual changes script and bunch of other artifacts that can be used later. These will be generated based on the package it will obtain from the previous package and the target database which will be used for compression.</p>
<p>In order to add a "<a href="http://library.octopusdeploy.com/#!/step-template/actiontemplate-redgate-create-database-release">Create Database Release Step</a>", you need to hit "Add step" on the Project &gt; Process page. From the "Choose step type" window, choose "Redgate - Create Database Release" option.</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/88d92e9a-b157-462e-bcaa-c9918f63491d.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/15dc6ed4-8027-4006-b2b0-50c0090aa285.png" width="644" height="419"></a></p>
<p>The step configuration will look something like below:</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/ab65cc7e-ee91-47ac-b0c5-83392766ce8e.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/252b321d-2a56-4c26-ad53-d79329c0b832.png" width="644" height="349"></a></p>
<p>As you can see, I am using <a href="http://docs.octopusdeploy.com/display/OD/Variables">Octopus Deploy variables</a> here. The ones that I have are as shown below:</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/537ce3e4-33df-4d20-9744-cd4eb6ef5e69.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/e50cd53e-040d-4d8b-b4f0-ce8da697f8e9.png" width="644" height="366"></a></p>
<p>Also note that I configured this step to be only run for the staging environment which will basically allow you to reuse the generated changes script to be deployed to production environment. This also means that reviewed script will be used in all deployments. As a final note: SQL Release will fail if the state of the target database is drifted from the compression state which makes the whole process safer. </p>
<blockquote>
<p>The next step is "Review Database Changes" which is a standard <a href="http://docs.octopusdeploy.com/display/OD/Manual+intervention+and+approvals">Octopus Deploy manual intervention and approval</a> step. I will skip that step here as the documentation is pretty straight forward on this.</p></blockquote>
<h4>Deploy from Database Release Step</h4>
<p>The last step is for actually deploying the changes. Once the sign-off is given, the changes to the database can be deployed. In order to start configuring this step, choose the "<a href="http://library.octopusdeploy.com/#!/step-template/actiontemplate-redgate-deploy-from-database-release">Redgate - Deploy from Database Release</a>" step type from the "Choose step type" window. The configuration will look something like below:</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/8019a49c-4755-47e8-9f42-a4d83b57a0d5.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/9a329166-7f16-41fa-86e9-6d56c4d670be.png" width="644" height="349"></a></p>
<p>One big difference here is that this step will be executed on both Staging and Production environments. In fact, this step is the only step that will run against the Production environment in our example here.</p>
<h3>Create a Release and Deploy</h3>
<p>We are now ready to create a release (alternatively, you can take advantage of "<a href="http://docs.octopusdeploy.com/display/OD/Automatic+Release+Creation">Automatic Release Creation</a>" feature of Octopus Deploy) and deploy to staging. When you start the deployment, it will pause on the manual intervention step as expected and we will see a few artifacts created on right hand side.</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/1265523b-8d53-4610-b091-31ae47071271.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/655df4bf-1aaa-41b7-8542-c8c879f54b5f.png" width="644" height="459"></a></p>
<p>You can see the update script, warnings and an HTML report for the changes. If you click on the Changes.html file, it will be download and you can open it up with your choice of web browser. It will give you a nice diff report.</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/26ecf886-6b16-443a-bd53-d32d31eaed3c.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/f8666274-d3e4-449e-acf2-2b7a01187b56.png" width="644" height="459"></a></p>
<p>Once you approve, the deployment will go on and the last step will run to actually deploy the changes. When you are happy with the staging environment, you can deploy the changes to Production by clicking the Promote button on Octopus server.</p>
<p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/5449d327-bac8-48fc-a1a6-56f4b993338a.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/5142c12f-1897-47b0-b510-8e25509d74d4.png" width="644" height="440"></a></p>
<p>As you can see, only step will run here is the last one. Remember that if the either of the database are drifted between the time of release creating and deployment, SQL Release will fail to deploy to make the process safer.</p>
<p>Obviously, SQL Release and its Octopus Deploy step templates make it easier to integrate with Octopus Deploy for deploying database schema changes in a safe and reliable way. If you feel that you are already struggling with making your database as part of your continuous delivery story, definitely try DLM Automation Suite and SQL Release out. You can also give feedback to <a href="https://redgate.uservoice.com/forums/267000-sql-release">SQL Release on its Uservoice page</a>.</p>  