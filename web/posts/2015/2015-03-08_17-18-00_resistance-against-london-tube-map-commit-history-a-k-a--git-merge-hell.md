---
title: Resistance Against London Tube Map Commit History (a.k.a. Git Merge Hell)
abstract: It's so easy to end up with git commit history which looks like London tube
  map. Let's see how we end up with those big, ugly, meaningless commit histories
  and how to prevent having one.
created_at: 2015-03-08 17:18:00 +0000 UTC
tags:
- Git
slugs:
- resistance-against-london-tube-map-commit-history-a-k-a--git-merge-hell
- resistance-against-git-repository-london-tube-map-commit-history-a-k-a--merge-hell
---

<p>If you have ever been to London, you probably know how complicated <a href="https://www.tfl.gov.uk/cdn/static/cms/documents/standard-tube-map.pdf">London tube map</a> looks like :)</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/b9ef190b-4179-4186-a643-4255dd30505f.jpg"><img title="2014-12-17 20.23.39" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="2014-12-17 20.23.39" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/6f8fe57c-e339-4336-b4aa-5fbfe5b7f150.jpg" width="644" height="484"></a></p> <p>There is no way for me to understand this unless I look at it for 100 times (and it was actually the reality). </p> <p>Most of the Git repository commit histories I look at nowadays are not much different from this map. For example, I cloned the original <a href="https://github.com/git/git">Git source code</a> and wanted to look at its commit history. I wish I didn’t do that as my eyes hurt really bad:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/1794bfb4-0b8c-48e7-ba81-deb6725aa238.png"><img title="Screenshot 2015-03-07 12.24.31" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Screenshot 2015-03-07 12.24.31" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/a462dc60-8944-4a9e-9828-d5d633a29985.png" width="644" height="349"></a></p> <p>This is the view of <a href="http://git-scm.com/docs/gitk">gitk</a> but it doesn’t matter what you use here. It looks as bad as the above one when you are just looking at the log:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/6b895329-df7d-48a8-af65-4fe91dc8f7f4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/abb8b71a-5447-4d53-9012-58591613aba6.png" width="450" height="484"></a></p> <p>Maybe I am being a little skeptical about it and maybe, it’s useful information there. Let’s look a little closer to see what it actually says:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/d773c1fe-4db8-4d2f-a994-c60f3f8cb6f0.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/5b71f708-45ed-48c2-971c-093072afd0c5.png" width="619" height="484"></a></p> <p>90% of the commits above are rubbish to me. YES, I am talking about those meaningless merge commits. They have no really value, they are just implementation details that happened during development and it makes no sense when I look at them later. I previously blogged about <a href="http://www.tugberkugurlu.com/archive/basics-of-git-rebase">how rebase can help taking away this pain</a>. However, it’s hard to apply rebasing model if you really don’t know what you are doing. I wanted to dig a little deeper in this post and share my opinions on this controversial topic.</p> <h3>How We Are Ending up With This Mess</h3> <p>Let’s take a very simple example and work on that to simulate how we are ending up with a mess like this. I have two repositories: one is called <a href="https://github.com/tugberkugurlu/london-tube-main">london-tube-main</a> (upstream) and the other one is <a href="https://github.com/tugberkugurlu/london-tube-fork">london-tube-fork</a> (origin). I only have one commit under upstream/master branch and I have one more additional commit under origin/doing-stuff branch as you can see below:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/e79bc2f1-cabe-4cc0-babe-de9f87ce102b.jpg"><img title="Picture6" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Picture6" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/fe8cf968-159f-4246-b3fe-dcdc498ae3cb.jpg" width="644" height="219"></a></p> <p>All seems good so far. I have the stable code inside <em>upstream/master</em> and I am working on a new stuff under <em>origin/doing-stuff</em>. Now, let’s make a new commit to upstream/master which we still continue cracking on origin/doing-stuff.</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/5218b51b-b878-4683-bbef-26ade467e74b.jpg"><img title="Picture5" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Picture5" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/d064f713-3375-4a42-a4b0-de97b898eb00.jpg" width="644" height="219"></a></p> <p>At that point, the origin/doing-stuff branch is out of sync. The logical option here is to sync with upstream/master before continue adding new stuff. In order to do that, I ran <em>git merge upstream/master</em> when I was under origin/doing-stuff. If I look at what happened there after running it, I would see something like this:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/82f68b0a-e9b6-4268-a4d0-00d77b1e2b01.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/1e9d8a7b-52d5-4495-a94d-abf4f7e1532d.png" width="644" height="429"></a></p> <p><a href="http://git-scm.com/docs/git-merge">Git merge manual</a> explains what actually happened here really well and I copied the description by changing only the references:</p> <blockquote> <p>Then "git merge upstream/master" will replay the changes made on the upstream/master branch since it diverged from master (i.e., 1) until its current commit (3) on top of master, and record the result in a new commit along with the names of the two parent commits and a log message from the user describing the changes.</p></blockquote> <p>Our simple progress flow would look like this now:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/e516541f-ffc5-45f6-a16d-6ac39913ec54.jpg"><img title="Picture7" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Picture7" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/4b8d69a0-2cd1-45d0-8a45-0ec560c398dd.jpg" width="644" height="172"></a></p> <p>At this state, I am in a feature branch working on my stuff. I now recorded a commit practically saying "I synced my branch, yay me!" which is pointless when you want to get this work into your stable branch. Let’s add one more commit on origin/doing-stuff. At the end, we have the following look:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/5031550c-ae8b-4d94-b64f-c0ffa35c6a8f.jpg"><img title="Picture8" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Picture8" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/d35ebcbc-1524-4c39-a028-af61c7b820b6.jpg" width="644" height="142"></a></p> <p>Except from the unnecessary merge commit, it is not that bad but this can get worse. Right now if you want to merge origin/doing-stuff branch into upstream/master, it will be a fast-forward merge which means only updating the branch pointer, without creating a merge commit. However, some prefers to disable this behavior with <a href="http://stackoverflow.com/questions/9069061/what-is-the-difference-between-git-merge-and-git-merge-no-ff">--no-ff switch</a> for the merge command which makes it possible to create a merge commit even when the merge resolves as a fast-forward. It makes the history look even worse by doing this.</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/c97ac40f-3ac7-4530-826e-1024d9f89f8e.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/92fed94d-c234-4525-b24e-91ec372452eb.png" width="644" height="270"></a></p> <p>Repeat this process over and over again, you will be really close to your own version of London tube map™!</p> <h3>How Can We Get Rid off This Mess</h3> <p>Let’s go back to one of our earlier states on our example:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/9655a640-69ab-4c83-981c-03d364a46f78.jpg"><img title="Picture5" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Picture5" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/40b2b4b1-7226-4557-a09e-6ef36fe7de3b.jpg" width="644" height="219"></a></p> <p>To refresh our memories, we now want to keep working on origin/doing-stuff branch but we are out of sync with the upstream/master branch. Previously, we blindly merged upstream/master into origin/doing-stuff branch but this time will rebase origin/doing-stuff onto upstream/master:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/03c00e74-58aa-49b6-8bc4-8730bcaae360.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/68ce542b-9ad7-4643-a198-85e2090406d0.png" width="644" height="203"></a></p> <p>We are now in sync with upstream/master but what happened here is actually really clever. When you are doing the rebase, git first takes your new commits and puts the upstream/master commits onto your branch. Later, it will&nbsp; apply each of your commits one by one. If you don’t have any conflicts, it will be a successful rebase as it was in our case here.</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/04427aa0-314e-4b00-adf6-e330587d8d40.jpg"><img title="Picture10" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Picture10" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/0ce3d8e8-8756-407f-b595-98787fdd5354.jpg" width="644" height="172"></a></p> <p>Notice that the <em>2</em> commit is now <em>new-2</em> commit. In reality, commits are identified by <a href="http://git-scm.com/book/no-nb/v1/Git-Internals-Git-Objects">SHA1 hash</a> and when you do a rebase, hash of your new commits will be recalculated as the parent commit is now changed, which will result in a rewritten history inside your feature branch. If you try to push your changes to origin/doing-stuff branch now, it will fail as the history is changed:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/a1e95211-dacd-4c28-b52d-fbcba582ef76.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/aa2136ee-4500-4bd6-b313-afa9844091f4.png" width="644" height="256"></a></p> <p>You can however force your changes to be pushed with <em>git push --force</em> command which will practically replace your history with the remote one:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/b91e4ae1-2ae2-45e4-955a-6583244c9542.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/33dcb609-1eb8-47db-bae0-50b7e3ceddd1.png" width="644" height="256"></a></p> <blockquote> <p><strong>DANGER ALERT!</strong></p> <p>You should really avoid doing force pushes against a branch which you share with somebody else. You really don’t want to piss your mates off :)</p> <p>It’s generally OK to force push into a feature branch inside your own fork which you are the only one who is working on it. Also, if you have an open pull request on GitHub attached to that branch, it will update the pull request when you force push which is nice. General rule of thumb here is that you should work on your own fork and shouldn’t push a feature branch into the shared remote upstream repository. This will generally make your life easier.</p></blockquote> <p>When you now add new commits and try to get these changes into upstream/master, it will just be a fast-forward merge (unless you have --no-ff merge rule in place).</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/306e1d12-a730-4be4-93eb-faffdfad72b9.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/74a8f2c5-10f1-4ef4-a0d0-9e8f9b06b642.png" width="644" height="217"></a></p> <p>Now, the history is so much cleaner:</p> <p><a href="https://tugberkugurlu.blob.core.windows.net/bloggyimages/27365ed6-4f22-41f8-84ef-38e242e254c2.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://tugberkugurlu.blob.core.windows.net/bloggyimages/9076e600-f42f-4cff-b18c-035b1a933ddd.png" width="644" height="217"></a></p> <h3>Conclusion</h3> <p>If you are on a long term big project where more than one person is involved, using merging like this in an obnoxious way and it will make you and your team suffer. You will feel in the same way like you felt when you first landed in London and picked up the London tube map, which is confusing, terrified. I agree that applying rebasing is hard but spend some time on this to get it right throughout your team. Do not even hesitate in spending a day to practice the flow in order to get it right. It may seem not important but it actually really is when you need to dig into the history of the code (e.g. <a href="http://git-scm.com/docs/git-bisect">git bisect</a>). A few simple rules that I follow which may also be helpful for you.</p> <ul> <li>Do your dirty stuff inside your own fork (you can go crazy, no one will care).</li> <li>Force <em>--ff-only</em> globally: <em>git config branch.master.mergeoptions&nbsp; "--ff-only"</em></li> <li>When you are on a feature branch, always <em>rebase</em> or <em>pull --rebase</em>.</li> <li>To make the history look more meaningful and modular, make use of <a href="http://nuclearsquid.com/writings/git-add/">git add -p</a><em></em> and <em><a href="https://help.github.com/articles/about-git-rebase/">git rebase –i</a></em></li> <li>Never rebase any shared branch onto your feature branch and force push to any shared branch. There is a really good chance of pissing your coworkers off by doing this :)</li></ul>  